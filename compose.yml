version: '3'

volumes:
  aperag_postgres_data: {}
  aperag_qdrant_data: {}

services:
  django: &django
    build:
      context: .
      dockerfile: ./Dockerfile
    image: aperag_django
    container_name: aperag_django
    depends_on:
      - postgres
      - redis
      - qdrant
    volumes:
      - .:/app:z
      - ~/.cache:/root/.cache
    env_file:
      - .docker-env
    ports:
      - "8000:8000"
    command: /app/scripts/start-django.sh

  postgres:
    image: postgres:14
    container_name: aperag_postgres
    volumes:
      - aperag_postgres_data:/var/lib/postgresql/data
    env_file:
      - .docker-env

  redis:
    image: redis:6
    container_name: aperag_redis

  qdrant:
    image: qdrant/qdrant
    container_name: aperag_qdrant
    volumes:
      - aperag_qdrant_data:/qdrant/storage

  celeryworker:
    <<: *django
    image: aperag_django
    container_name: aperag_celeryworker
    depends_on:
      - redis
      - postgres
      - qdrant
    volumes:
      - .:/app:z
      - ~/.cache:/root/.cache
      - ./resources:/Users/ziang/git/ApeRAG/resources
    ports: []
    command: /app/scripts/start-celery-worker.sh

  celerybeat:
    <<: *django
    image: aperag_django
    container_name: aperag_celerybeat
    depends_on:
      - redis
      - postgres
    ports: []
    command: /app/scripts/start-celery-beat.sh

  flower:
    <<: *django
    image: aperag_django
    container_name: aperag_flower
    ports:
      - "5555:5555"
    command: /app/scripts/start-celery-flower.sh